{% extends "dashboard_base.html" %}

{% block title %}Vocalyx Dashboard{% endblock %}

{% block page_content %}
<div class="view-wrapper" data-view="transcriptions">
    <section class="panel hero-panel">
        <div class="panel-header">
            <div>
                <h1>Transcriptions</h1>
                <p>Suivez l'√©tat des uploads et la disponibilit√© des workers en temps r√©el.</p>
            </div>
            <div style="display:flex;align-items:center;gap:1rem;">
                <div id="worker-status-container" class="worker-status-pill">
                    <span class="worker-status-light"></span>
                    Initialisation des workers...
                </div>
                <button id="cta-transcribe-btn" class="btn btn-warning cta-hero-btn" type="button">Nouvelle transcription</button>
            </div>
        </div>

        <div class="filters-panel">
            <div class="filter-field">
                <label for="project-filter">Projet</label>
                <select id="project-filter">
                    <option value="">Tous les projets</option>
                </select>
            </div>
            <div class="filter-field">
                <label for="status-filter">Statut</label>
                <select id="status-filter">
                    <option value="">Tous</option>
                    <option value="pending">En attente</option>
                    <option value="processing">En cours</option>
                    <option value="transcribed">Transcrit</option>
                    <option value="done">Termin√©</option>
                    <option value="error">Erreur</option>
                </select>
            </div>
            <div class="filter-field search-field">
                <label for="search-input">Recherche</label>
                <input type="text" id="search-input" placeholder="ID, projet, langue...">
                <small class="search-help-text">Recherche sur ID, nom de projet, langue</small>
            </div>
            <div class="filter-field filter-actions">
                <label>&nbsp;</label>
                <div style="display:flex;align-items:center;gap:0.5rem;">
                    <span id="filters-active-badge" class="filters-active-badge" style="display:none;">
                        <span id="filters-count">0</span> filtre(s) actif(s)
                    </span>
                    <button id="reset-filters-btn" class="btn btn-danger reset-filters-btn" style="display:none;">R√©initialiser</button>
                </div>
            </div>
        </div>
    </section>

    <section class="panel">
        <div class="panel-header">
            <h2>Liste des transcriptions</h2>
        </div>
        <div class="table-wrapper">
            <table class="grid-table">
                <thead>
                    <tr>
                        <th class="col-status">Statut</th>
                        <th class="col-project">Projet</th>
                        <th class="col-id">ID</th>
                        <th class="group-header" colspan="2">Workers</th>
                        <th class="col-lang">Langue</th>
                        <th class="group-header" colspan="2">Temps</th>
                        <th class="col-date">Cr√©√© le</th>
                        <th class="col-actions">Actions</th>
                    </tr>
                    <tr>
                        <th></th><th></th><th></th>
                        <th class="col-worker-transcribe" title="Worker de transcription">Transcription</th>
                        <th class="col-worker-enrichment" title="Worker d'enrichissement">Enrichissement</th>
                        <th></th>
                        <th class="col-duree dur-group" title="Dur√©e totale de l'audio en secondes">Dur√©e</th>
                        <th class="col-process dur-group" title="Temps de traitement total (transcription + enrichissement) en secondes">Traitement</th>
                        <th></th><th></th>
                    </tr>
                </thead>
                <tbody id="grid-table-body"></tbody>
            </table>
            <div id="transcriptions-cards" class="transcriptions-cards"></div>
        </div>
        <div class="pagination" id="pagination"></div>
    </section>
</div>

{% if user_is_admin %}
<div class="view-wrapper" data-view="projects">
    <section class="panel hero-panel">
        <div class="panel-header">
            <div>
                <h1>Projets</h1>
                <p>Cr√©ez, organisez et surveillez vos espaces d'API.</p>
            </div>
            <div class="panel-actions">
                <button id="refresh-projects-btn" class="btn btn-primary">Rafra√Æchir</button>
                <a href="/admin" class="btn btn-success">Centre Admin</a>
            </div>
        </div>
        <p class="hero-description">
            Chaque projet dispose de sa propre cl√© API. Visualisez rapidement les espaces actifs et leurs secrets.
        </p>
    </section>

    <section class="panel">
        <div class="panel-header">
            <h2>Catalogue des projets</h2>
        </div>
        <div id="projects-grid" class="projects-grid">
            <div class="section-empty">
                Chargement des projets en cours...
            </div>
        </div>
    </section>

    <section class="panel">
        <div class="panel-header">
            <h2>Gestion des Projets</h2>
        </div>

        <div class="form-group-inline project-create-form">
            <input type="text" id="new-project-name-input" placeholder="Nom du nouveau projet">
            <button id="create-project-btn" class="btn btn-primary">Cr√©er</button>
        </div>

        <div class="table-wrapper">
            <table class="grid-table">
                <thead>
                    <tr>
                        <th>Projet</th>
                        <th>Cl√© API (cliquez pour r√©v√©ler)</th>
                        <th>Cr√©√© le</th>
                    </tr>
                </thead>
                <tbody id="projects-table-body">
                    <tr><td colspan="3" style="text-align:center;">Chargement...</td></tr>
                </tbody>
            </table>
        </div>
    </section>
</div>
{% endif %}

<div class="view-wrapper" data-view="users">
    <section class="panel hero-panel">
        <div class="panel-header">
            <div>
                <h1>Utilisateurs & Acc√®s</h1>
                <p>Centralisez les r√¥les et l'association aux projets.</p>
            </div>
        </div>
        <p class="hero-description">
            G√©rez vos utilisateurs, leurs r√¥les et leurs projets associ√©s directement ici.
        </p>
    </section>

    {% if user_is_admin %}
    <section class="panel placeholder-panel">
        <div class="panel-header">
            <h2>Cr√©er un utilisateur</h2>
        </div>
        <div class="form-group-inline user-create-form">
            <input type="text" id="new-user-username" placeholder="Nom d'utilisateur" required minlength="3">
            <input type="password" id="new-user-password" placeholder="Mot de passe" required minlength="6">
            <div class="password-strength">
                <div class="password-strength-bar" id="password-strength-bar"></div>
            </div>
            <label class="user-admin-toggle">
                <input type="checkbox" id="new-user-is-admin">
                <span>Admin</span>
            </label>
            <button id="create-user-btn" class="btn btn-primary">Cr√©er</button>
        </div>
    </section>
    {% else %}
    <section class="panel placeholder-panel">
        <div class="panel-header">
            <h2>Acc√®s restreint</h2>
        </div>
        <div style="padding:2rem;text-align:center;color:#666;">
            <p style="font-size:1.1rem;margin-bottom:1rem;">Acc√®s r√©serv√© aux administrateurs.</p>
            <p>Contactez un administrateur pour g√©rer les comptes utilisateurs.</p>
        </div>
    </section>
    {% endif %}

    <section class="panel">
        <div class="panel-header">
            <h2>Utilisateurs existants</h2>
        </div>
        <div id="users-list-container" class="users-list">
            <p>Chargement des utilisateurs...</p>
        </div>
    </section>
</div>

{% if user_is_admin %}
<div class="view-wrapper" data-view="workers">
    <section class="panel hero-panel">
        <div class="panel-header">
            <div>
                <h1>Workers Celery</h1>
                <p>Visualisez la capacit√©, la sant√© CPU/RAM et la charge de vos workers.</p>
            </div>
            <div class="panel-actions">
                <a href="{{ flower_url }}" target="_blank" class="btn btn-primary" style="margin-right:1rem;" title="Ouvrir Flower dans un nouvel onglet">
                    üå∏ Ouvrir Flower
                </a>
                <span>Actualis√© via WebSocket</span>
            </div>
        </div>
        <p class="hero-description">
            Les donn√©es sont mises √† jour en temps r√©el via Redis Pub/Sub et Celery.
            Ajustez vos workers depuis <code>make scale-workers</code> pour absorber plus de charge.
        </p>
    </section>

    <section class="panel">
        <div class="panel-header">
            <h2>Monitoring temps r√©el</h2>
        </div>
        <div class="table-wrapper">
            <table class="grid-table worker-monitoring-table">
                <thead>
                    <tr>
                        <th class="col-instance">Instance</th>
                        <th class="col-type">Type</th>
                        <th class="col-status">Statut</th>
                        <th class="col-charge-num">Charge (Nb)</th>
                        <th class="col-charge-bar">Charge %</th>
                        <th class="col-cpu-num">CPU %</th>
                        <th class="col-cpu-bar">CPU</th>
                        <th class="col-ram-num">RAM %</th>
                        <th class="col-ram-bar">RAM</th>
                        <th class="col-uptime">Uptime</th>
                        <th class="col-jobs">T√¢ches (total)</th>
                        <th class="col-audio">Tps Audio Trait√©</th>
                    </tr>
                </thead>
                <tbody id="worker-monitoring-grid"></tbody>
            </table>
        </div>
    </section>
</div>
{% endif %}

<div class="view-wrapper" data-view="statistics">
    <section class="panel hero-panel">
        <div class="panel-header">
            <div>
                <h1>Statistiques</h1>
                <p>Indicateurs consolid√©s mis √† jour via WebSocket.</p>
            </div>
            <div class="panel-actions">
                <span>Temps r√©el</span>
            </div>
        </div>
        <p class="hero-description">
            Ces m√©triques proviennent de la base Vocalyx ainsi que des sondes Celery.
            Elles se rafra√Æchissent automatiquement sans recharger la page.
        </p>
    </section>

    <section class="panel stats-panel">
        <div class="panel-header">
            <h2>Vue globale</h2>
        </div>
        <div class="stats-grid">
            <div class="stat-card">
                <span class="stat-label">Projets actifs</span>
                <span class="stat-value" id="stat-projects">‚Äî</span>
                <span class="stat-subtitle">en temps r√©el</span>
                <canvas class="sparkline" id="sparkline-projects" width="100" height="30"></canvas>
            </div>
            <div class="stat-card">
                <span class="stat-label">Utilisateurs</span>
                <span class="stat-value" id="stat-users">‚Äî</span>
                <span class="stat-subtitle">total</span>
                <canvas class="sparkline" id="sparkline-users" width="100" height="30"></canvas>
            </div>
            <div class="stat-card">
                <span class="stat-label">Workers connect√©s</span>
                <span class="stat-value" id="stat-workers">‚Äî</span>
                <span class="stat-subtitle">actifs</span>
                <canvas class="sparkline" id="sparkline-workers" width="100" height="30"></canvas>
            </div>
            <div class="stat-card">
                <span class="stat-label">Transcriptions suivies</span>
                <span class="stat-value" id="stat-transcriptions">‚Äî</span>
                <span class="stat-subtitle">sur 24h</span>
                <canvas class="sparkline" id="sparkline-transcriptions" width="100" height="30"></canvas>
            </div>
        </div>
    </section>
</div>

<div id="upload-modal" class="modal">
    <div class="modal-content" style="max-width: 600px; max-height: 90vh; overflow-y: auto;">
        <span class="close" id="upload-modal-close">&times;</span>
        <div class="upload-modal-body">
            <h2>Nouvelle Transcription</h2>
            
            <!-- Stepper visuel -->
            <div class="upload-stepper">
                <div class="upload-step-item active" data-step="1">
                    <div class="upload-step-number">1</div>
                    <div class="upload-step-label">Projet</div>
                </div>
                <div class="upload-step-item" data-step="2">
                    <div class="upload-step-number">2</div>
                    <div class="upload-step-label">Cl√© API</div>
                </div>
                <div class="upload-step-item" data-step="3">
                    <div class="upload-step-number">3</div>
                    <div class="upload-step-label">Fichier</div>
                </div>
                <div class="upload-step-item" data-step="4">
                    <div class="upload-step-number">4</div>
                    <div class="upload-step-label">Options</div>
                </div>
            </div>
            
            <div class="form-group upload-step">√âtape 1 : Projet de destination</div>
            <div class="form-group">
                <label for="upload-project-select">Projet :</label>
                <select id="upload-project-select"></select>
            </div>
            <div class="form-group upload-step">√âtape 2 : Cl√© API du projet</div>
            <div class="form-group">
                <label for="upload-api-key-input">Cl√© API :</label>
                <input type="password" id="upload-api-key-input" placeholder="Collez la cl√© API (vk_...) ici">
                <small>Note: Pour le projet 'default_internal', la cl√© est inject√©e automatiquement.</small>
            </div>
            <div class="form-group upload-step">√âtape 3 : Fichier Audio</div>
            <div class="form-group">
                <label for="upload-file-input">Fichier audio :</label>
                <input type="file" id="upload-file-input" accept="audio/*">
            </div>
            <div class="form-group upload-step">√âtape 4 : Options</div>
            <div class="form-group">
                <label for="upload-quality-slider">Qualit√© de transcription :</label>
                <div class="quality-slider-container">
                    <input type="range" id="upload-quality-slider" min="0" max="3" value="2" class="quality-slider">
                    <div class="quality-labels">
                        <span class="quality-label" data-value="0">
                            <strong>Rapide</strong>
                        </span>
                        <span class="quality-label" data-value="1">
                            <strong>Mod√©r√©</strong>
                        </span>
                        <span class="quality-label active" data-value="2">
                            <strong>√âquilibr√©</strong>
                        </span>
                        <span class="quality-label" data-value="3">
                            <strong>Haute</strong>
                        </span>
                    </div>
                    <div class="quality-value-display" id="quality-value-display">√âquilibr√©</div>
                </div>
                <div style="margin-top: 0.5rem;">
                    <input type="checkbox" id="upload-use-vad" checked>
                    <label for="upload-use-vad" style="display: inline-block; font-weight: normal; margin-left: 0.5rem;">Utiliser la d√©tection de voix (VAD)</label>
                </div>
                <div style="margin-top: 0.5rem;">
                    <input type="checkbox" id="upload-use-diarization">
                    <label for="upload-use-diarization" style="display: inline-block; font-weight: normal; margin-left: 0.5rem;">Activer la diarisation (identification des locuteurs)</label>
                </div>
            </div>
            
            <div class="form-group upload-step">√âtape 5 : Enrichissement (optionnel)</div>
            <div class="form-group">
                <div style="display: flex; align-items: center; margin-bottom: 0.5rem;">
                    <input type="checkbox" id="upload-enrichment" style="margin-right: 0.5rem;">
                    <label for="upload-enrichment" style="font-weight: normal; margin: 0;">Activer l'enrichissement (titre, r√©sum√©, score, bullet points) - Enrichissement de base</label>
                </div>
                <div style="display: flex; align-items: center; margin-top: 0.5rem; padding-left: 1.5rem;">
                    <input type="checkbox" id="upload-text-correction" style="margin-right: 0.5rem;">
                    <label for="upload-text-correction" style="font-weight: normal; margin: 0;">Correction du texte (orthographe, grammaire) - ‚ö†Ô∏è Option s√©par√©e et co√ªteuse</label>
                </div>
                
                <div id="enrichment-options" style="margin-top: 1rem; padding-left: 1.5rem; border-left: 3px solid #4a90e2; display: none;">
                    <div class="form-group" style="margin-top: 0.5rem;">
                        <label for="upload-llm-model">Mod√®le LLM :</label>
                        <select id="upload-llm-model">
                            <option value="phi-3-mini" selected>Phi-3-mini (rapide, 2.3 GB)</option>
                            <option value="mistral-7b-instruct">Mistral-7B-Instruct v0.3 (√©quilibr√©, 4.1 GB)</option>
                        </select>
                        <small>Mod√®le depuis shared/models/enrichment/ ou nom de mod√®le recommand√©</small>
                    </div>
                    
                    <div class="form-group">
                        <label>Prompts personnalis√©s (optionnel) :</label>
                        <details style="margin-top: 0.5rem;">
                            <summary style="cursor: pointer; color: #4a90e2;">‚úèÔ∏è √âditer les prompts</summary>
                            <div style="margin-top: 0.5rem;">
                                <label for="enrichment-prompt-title" style="font-size: 0.9rem;">Prompt pour le titre :</label>
                                <textarea id="enrichment-prompt-title" rows="2" style="width: 100%; font-size: 0.9rem; padding: 0.5rem;" placeholder="G√©n√®re un titre court et accrocheur (maximum 10 mots) pour cette transcription:"></textarea>
                                
                                <label for="enrichment-prompt-summary" style="font-size: 0.9rem; margin-top: 0.5rem; display: block;">Prompt pour le r√©sum√© :</label>
                                <textarea id="enrichment-prompt-summary" rows="2" style="width: 100%; font-size: 0.9rem; padding: 0.5rem;" placeholder="G√©n√®re un r√©sum√© concis de moins de 100 mots pour cette transcription:"></textarea>
                                
                                <label for="enrichment-prompt-satisfaction" style="font-size: 0.9rem; margin-top: 0.5rem; display: block;">Prompt pour le score de satisfaction :</label>
                                <textarea id="enrichment-prompt-satisfaction" rows="2" style="width: 100%; font-size: 0.9rem; padding: 0.5rem;" placeholder="Analyse cette transcription et attribue un score de satisfaction client de 1 √† 10. Justifie bri√®vement ton score. Format JSON: {&quot;score&quot;: nombre, &quot;justification&quot;: &quot;texte&quot;}"></textarea>
                                
                                <label for="enrichment-prompt-bullets" style="font-size: 0.9rem; margin-top: 0.5rem; display: block;">Prompt pour les bullet points :</label>
                                <textarea id="enrichment-prompt-bullets" rows="2" style="width: 100%; font-size: 0.9rem; padding: 0.5rem;" placeholder="Extrais les points cl√©s de cette transcription sous forme de puces. Format JSON: {&quot;points&quot;: [&quot;point 1&quot;, &quot;point 2&quot;, ...]}"></textarea>
                            </div>
                        </details>
                    </div>
                </div>
            </div>
            <button id="upload-submit-btn" class="btn btn-success" style="width: 100%; padding: 0.8rem; font-size: 1rem;">Lancer la transcription</button>
        </div>
    </div>
</div>
{% endblock %}

