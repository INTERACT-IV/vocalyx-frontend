<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<title>{% block title %}{{ page_title or "Vocalyx Dashboard" }}{% endblock %}</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/toastr@2.1.4/build/toastr.min.css">
<link rel="stylesheet" href="/static/css/dashboard.css">
</head>
<body data-page="{{ active_page or 'transcriptions' }}">
<div class="loading-overlay" id="loading-overlay">
    <div class="spinner"></div>
</div>

<button class="sidebar-toggle" id="sidebar-toggle" aria-label="Toggle sidebar">‚ò∞</button>
<div class="app-shell">
    <aside class="sidebar" id="sidebar">
        <div class="brand">
            <div class="brand-logo">üéôÔ∏è</div>
            <div>
                <p class="brand-title">Vocalyx</p>
                <p class="brand-subtitle">Audio Intelligence</p>
            </div>
        </div>

        <div class="sidebar-time">
            <span id="current-time"></span>
        </div>

        <div class="sidebar-user-info">
            <p class="user-name">{{ current_username or "Utilisateur" }}</p>
            <p class="user-last-login">
                Derni√®re connexion :
                {% if user_last_login %}
                    {{ user_last_login }}
                {% else %}
                    Jamais
                {% endif %}
            </p>
        </div>

        <nav class="sidebar-nav">
            <button class="sidebar-link" data-view="transcriptions">
                <span class="sidebar-icon">üîä</span>Transcriptions
            </button>
            {% if user_is_admin %}
            <button class="sidebar-link" data-view="projects">
                <span class="sidebar-icon">üìÅ</span>Projets
            </button>
            {% endif %}
            <button class="sidebar-link" data-view="users" {% if not user_is_admin %}title="Acc√®s r√©serv√© aux administrateurs"{% endif %}>
                <span class="sidebar-icon">üë§</span>Utilisateurs
            </button>
            {% if user_is_admin %}
            <button class="sidebar-link" data-view="workers">
                <span class="sidebar-icon">‚öôÔ∏è</span>Workers
            </button>
            {% endif %}
            <button class="sidebar-link" data-view="statistics">
                <span class="sidebar-icon">üìä</span>Statistiques
            </button>
        </nav>

        <div class="sidebar-actions">
            <button id="open-upload-modal-btn" class="btn btn-warning full-width">Nouvelle transcription</button>
            <button id="export-btn" class="btn btn-success full-width">Exporter</button>
            <a href="/auth/logout" class="btn btn-danger full-width">D√©connexion</a>
        </div>
    </aside>

    <main class="main-content">
        <div id="context-banner" class="context-banner" style="display:none"></div>
        {% block page_content %}{% endblock %}
    </main>
</div>

<div id="modal" class="modal" role="dialog" aria-modal="true" aria-labelledby="modal-title">
    <div class="modal-content">
        <span class="close" aria-label="Fermer la modale">&times;</span>
        <div id="modal-body"></div>
    </div>
</div>

<div id="upload-modal" class="modal">
    <div class="modal-content" style="max-width: 550px;">
        <span class="close" id="upload-modal-close">&times;</span>
        <div class="upload-modal-body">
            <h2>Nouvelle Transcription</h2>
            
            <!-- Stepper visuel -->
            <div class="upload-stepper">
                <div class="upload-step-item active" data-step="1">
                    <div class="upload-step-number">1</div>
                    <div class="upload-step-label">Projet</div>
                </div>
                <div class="upload-step-item" data-step="2">
                    <div class="upload-step-number">2</div>
                    <div class="upload-step-label">Cl√© API</div>
                </div>
                <div class="upload-step-item" data-step="3">
                    <div class="upload-step-number">3</div>
                    <div class="upload-step-label">Fichier</div>
                </div>
                <div class="upload-step-item" data-step="4">
                    <div class="upload-step-number">4</div>
                    <div class="upload-step-label">Options</div>
                </div>
            </div>
            
            <div class="form-group upload-step">√âtape 1 : Projet de destination</div>
            <div class="form-group">
                <label for="upload-project-select">Projet :</label>
                <select id="upload-project-select"></select>
            </div>
            
            <div class="form-group upload-step">√âtape 2 : Cl√© API du projet</div>
            <div class="form-group">
                <label for="upload-api-key-input">Cl√© API :</label>
                <input type="password" id="upload-api-key-input" placeholder="Collez la cl√© API (vk_...) ici">
                <small>Note: Pour le projet 'default_internal', la cl√© est inject√©e automatiquement.</small>
            </div>

            <div class="form-group upload-step">√âtape 3 : Fichier Audio</div>
            <div class="form-group">
                <label for="upload-file-input">Fichier audio :</label>
                <input type="file" id="upload-file-input" accept="audio/*">
            </div>
            
            <div class="form-group upload-step">√âtape 4 : Options</div>
            <div class="form-group">
                <input type="checkbox" id="upload-use-vad" checked>
                <label for="upload-use-vad" style="display: inline-block; font-weight: normal;">Utiliser la d√©tection de voix (VAD)</label>
            </div>
            
            <button id="upload-submit-btn" class="btn btn-success" style="width: 100%; padding: 0.8rem; font-size: 1rem;">Lancer la transcription</button>
        </div>
    </div>
</div>

<div id="projects-modal" class="modal">
    <div class="modal-content" style="max-width: 700px;">
        <span class="close" id="projects-modal-close">&times;</span>
        <h2>Gestion des Projets</h2>
        
        <div class="form-group-inline">
            <input type="text" id="new-project-name-input" placeholder="Nom du nouveau projet">
            <button id="create-project-btn" class="btn btn-primary">Cr√©er</button>
        </div>
        
        <table class="grid-table" style="margin-top: 1rem;">
            <thead>
                <tr>
                    <th>Projet</th>
                    <th>Cl√© d'API (X-API-Key)</th>
                    <th>Cr√©√© le</th>
                </tr>
            </thead>
            <tbody id="projects-table-body"></tbody>
        </table>
    </div>
</div>

<script>
    window.VOCALYX_CONFIG = {
        API_URL: "{{ api_url|e }}",
        DEFAULT_PROJECT_NAME: "{{ DEFAULT_PROJECT_NAME|e }}",
        DEFAULT_PROJECT_KEY: "{{ DEFAULT_PROJECT_KEY|e }}",
        USER_IS_ADMIN: {{ 'true' if user_is_admin else 'false' }}
    };
    window.VOCALYX_PAGE = "{{ active_page or 'transcriptions' }}";
    console.log("‚úÖ VOCALYX_CONFIG loaded:", window.VOCALYX_CONFIG);
</script>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/toastr@2.1.4/build/toastr.min.js"></script>
<script src="/static/js/utils.js"></script>
<script src="/static/js/api.js"></script>
<script src="/static/js/modal.js"></script>
<script src="/static/js/cards.js"></script>
<script src="/static/js/events.js"></script>
<script src="/static/js/main.js"></script>
{% block extra_scripts %}{% endblock %}
</body>
</html>

